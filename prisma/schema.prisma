generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Attendance {
  id            String            @id
  userId        String
  sessionId     String
  status        AttendanceStatus  @default(ABSENT)
  checkInAt     DateTime?
  checkOutAt    DateTime?
  method        AttendanceMethod?
  latitude      Float?
  longitude     Float?
  zoomDuration  Int?
  notes         String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime
  CourseSession CourseSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  User          User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, sessionId])
  @@index([sessionId])
}

model AttendanceToken {
  id            String        @id
  sessionId     String
  token         String        @unique
  expiresAt     DateTime
  createdAt     DateTime      @default(now())
  CourseSession CourseSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([token])
}

model AuditLog {
  id        String   @id
  userId    String?
  action    String
  entity    String
  entityId  String?
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([entity, entityId])
  @@index([userId])
}

model Badge {
  id          String      @id
  name        String
  description String
  icon        String
  type        BadgeType
  criteria    Json
  points      Int         @default(0)
  createdAt   DateTime    @default(now())
  UserBadge   UserBadge[]
}

model Certificate {
  id               String   @id
  userId           String
  courseId         String
  certificateNo    String   @unique
  issuedAt         DateTime @default(now())
  pdfUrl           String?
  verificationCode String   @unique
  isValid          Boolean  @default(true)
  Course           Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  User             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([certificateNo])
  @@index([verificationCode])
}

model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  icon        String?
  description String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  Course      Course[]
}

model Course {
  id            String          @id
  title         String
  slug          String          @unique
  description   String
  thumbnail     String?
  previewUrl    String?         @map("preview_url")
  deliveryMode  DeliveryMode    @default(ASYNC_ONLINE)
  difficulty    Difficulty      @default(BEGINNER)
  category      String?         // Legacy field for backward compatibility
  categoryId    String?         @map("category_id")
  Category      Category?       @relation(fields: [categoryId], references: [id])
  tags          String[]
  capacity      Int?
  duration      Int?
  startDate     DateTime?
  endDate       DateTime?
  isPublished   Boolean         @default(false)
  isFeatured    Boolean         @default(false)
  instructorId  String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  
  // Course Metadata Fields
  courseShortDesc String?   @map("course_short_desc")
  courseDesc      String?   @map("course_desc")
  courseLevel     String?   @default("Beginner") @map("course_level")
  language        String?   @default("Bahasa Indonesia")
  requirements    String?
  outcomes        String?
  recommendedNext String?   @map("recommended_next")
  jp              Decimal?  @db.Decimal(8, 2)
  
  Certificate   Certificate[]
  User          User            @relation(fields: [instructorId], references: [id])
  CourseSession CourseSession[]
  Enrollment    Enrollment[]
  Forum         Forum[]
  Module        Module[]
  SyncCourseProgress SyncCourseProgress[]
  FeedbackSurvey     FeedbackSurvey[]
  
  // YouTube Integration Fields
  ytPlaylistId      String?   @unique
  isProcessing      Boolean   @default(false)
  processingStatus  String?   // 'pending', 'processing', 'completed', 'failed'
  lastProcessedAt   DateTime?
  
  // Sync Course Configuration
  // Config: { advanceOrganizer, learningFocus[], youtubeStreamUrl, conceptValidation[] }
  syncConfig        Json?     @map("sync_config")

  @@index([deliveryMode])
  @@index([instructorId])
  @@index([slug])
}

model CourseSession {
  id              String            @id
  courseId        String
  title           String
  description     String?
  type            SessionType
  startTime       DateTime
  endTime         DateTime
  timezone        String            @default("Asia/Jakarta")
  location        String?
  address         String?
  latitude        Float?
  longitude       Float?
  geoRadius       Int?
  zoomMeetingId   String?
  zoomJoinUrl     String?
  zoomStartUrl    String?
  zoomPassword    String?
  recordingUrl    String?
  maxParticipants Int?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  Attendance      Attendance[]
  AttendanceToken AttendanceToken[]
  FeedbackSurvey  FeedbackSurvey[]
  Course          Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([startTime])
}

model Enrollment {
  id              String           @id
  userId          String
  courseId        String
  status          EnrollmentStatus @default(ENROLLED)
  enrolledAt      DateTime         @default(now())
  completedAt     DateTime?
  progressPercent Float            @default(0)
  lastAccessedAt  DateTime?
  Course          Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  User            User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
  @@index([userId])
}

model Forum {
  id          String      @id
  courseId    String
  title       String
  description String?
  createdAt   DateTime    @default(now())
  Course      Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  ForumPost   ForumPost[]

  @@index([courseId])
}

model ForumComment {
  id        String    @id
  postId    String
  userId    String
  content   String
  createdAt DateTime  @default(now())
  updatedAt DateTime
  ForumPost ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
}

model ForumPost {
  id           String         @id
  forumId      String
  userId       String
  title        String
  content      String
  isPinned     Boolean        @default(false)
  isLocked     Boolean        @default(false)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  ForumComment ForumComment[]
  Forum        Forum          @relation(fields: [forumId], references: [id], onDelete: Cascade)
  User         User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([forumId])
}

model Lesson {
  id          String      @id
  title       String
  description String?
  order       Int
  contentType ContentType
  content     String?
  videoUrl    String?
  fileUrl     String?
  scormUrl    String?
  externalUrl String?
  duration    Int?
  moduleId    String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime
  Module      Module      @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  Progress    Progress[]
  
  // YouTube Integration Fields
  ytVideoId         String?
  transcript        String?
  summary           String?
  processingStatus  String?   // 'pending', 'processing', 'completed', 'failed'
  error             String?
  audioFilePath     String?   // Internal path to extracted audio

  @@index([moduleId])
}

model Module {
  id          String   @id
  title       String
  description String?
  order       Int
  courseId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  Lesson      Lesson[]
  Course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  Quiz        Quiz[]

  @@index([courseId])
}

model Notification {
  id        String           @id
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())
  User      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isRead])
  @@index([userId])
}

model Progress {
  id               String    @id
  userId           String
  lessonId         String
  isCompleted      Boolean   @default(false)
  completedAt      DateTime?
  watchedSeconds   Int?
  timeSpentMinutes Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime
  Lesson           Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  User             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
}

model Question {
  id             String           @id
  quizId         String
  type           QuestionType
  text           String
  explanation    String?
  points         Int              @default(1)
  order          Int
  options        Json?
  rubric         Json?
  modelAnswer    String?
  Quiz           Quiz             @relation(fields: [quizId], references: [id], onDelete: Cascade)
  QuestionAnswer QuestionAnswer[]

  @@index([quizId])
}

model QuestionAnswer {
  id              String      @id
  attemptId       String
  questionId      String
  answer          String?
  selectedOptions Json?
  isCorrect       Boolean?
  pointsEarned    Float?
  aiFeedback      String?
  QuizAttempt     QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  Question        Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
}

model Quiz {
  id                 String        @id
  title              String
  description        String?
  moduleId           String
  type               QuizType      @default(QUIZ)
  passingScore       Float         @default(70)
  timeLimit          Int?
  maxAttempts        Int           @default(1)
  shuffleQuestions   Boolean       @default(true)
  shuffleOptions     Boolean       @default(false)
  showCorrectAnswers Boolean       @default(true)
  isAIGenerated      Boolean       @default(false)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime
  Question           Question[]
  Module             Module        @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  QuizAttempt        QuizAttempt[]

  @@index([moduleId])
}

model QuizAttempt {
  id             String           @id
  userId         String
  quizId         String
  startedAt      DateTime         @default(now())
  submittedAt    DateTime?
  score          Float?
  isPassed       Boolean?
  gradingStatus  GradingStatus    @default(PENDING)
  QuestionAnswer QuestionAnswer[]
  Quiz           Quiz             @relation(fields: [quizId], references: [id], onDelete: Cascade)
  User           User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SystemSetting {
  id        String   @id
  key       String   @unique
  value     String
  updatedAt DateTime
}

model User {
  id            String         @id @default(cuid())
  nip           String?        @unique
  email         String         @unique
  name          String?
  password      String?
  image         String?
  emailVerified DateTime?
  phoneVerified DateTime?
  unitKerja     String?
  phone         String?        // Nomor WhatsApp untuk notifikasi
  jabatan       String?
  pangkat       String?
  points        Int            @default(0)
  level         Int            @default(1)
  streak        Int            @default(0)
  lastActiveAt  DateTime?
  role          Role           @default(LEARNER)
  status        UserStatus     @default(ACTIVE)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @default(now()) @updatedAt
  accounts      Account[]
  Attendance    Attendance[]
  Certificate   Certificate[]
  Course        Course[]
  Enrollment    Enrollment[]
  ForumComment  ForumComment[]
  ForumPost     ForumPost[]
  Notification  Notification[]
  Progress      Progress[]
  QuizAttempt   QuizAttempt[]
  sessions      Session[]
  UserBadge     UserBadge[]
  UserVerificationOTP UserVerificationOTP[]
  LearnerActivity LearnerActivity[]
  SyncCourseProgress SyncCourseProgress[]
  FeedbackResponse FeedbackResponse[]
  
  // WBLM Relations
  WblmProgramsOwned          WblmProgram[]              @relation("WblmProgramOwner")
  WblmEnrollmentsAsParticipant WblmEnrollment[]         @relation("WblmEnrollmentParticipant")
  WblmEnrollmentsAsSupervisor  WblmEnrollment[]         @relation("WblmEnrollmentSupervisor")
  WblmSubmissions            WblmSubmission[]           @relation("WblmSubmissionParticipant")
  WblmReviewAssignmentsAsParticipant WblmReviewAssignment[] @relation("WblmReviewAssignmentParticipant")
  WblmReviewAssignmentsAsReviewer    WblmReviewAssignment[] @relation("WblmReviewAssignmentReviewer")
  WblmReviews                WblmReview[]               @relation("WblmReviewReviewer")
  WblmReflections            WblmReflection[]           @relation("WblmReflectionParticipant")
  WblmEvidencePackages       WblmEvidencePackage[]      @relation("WblmEvidenceParticipant")
  WblmParticipantMilestones  WblmParticipantMilestone[] @relation("WblmMilestoneParticipant")

  @@index([email])
  @@index([nip])
  @@index([unitKerja])
}

model UserVerificationOTP {
  id        String   @id @default(cuid())
  userId    String
  type      String   // "EMAIL" | "PHONE"
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model YtPlaylist {
  id                  String    @id @default(uuid()) @db.Uuid
  playlistId          String    @unique @map("playlist_id")
  playlistTitle       String    @map("playlist_title")
  playlistUrl         String    @unique @map("playlist_url")
  author              String?
  totalItems          Int?      @default(0) @map("total_items")
  totalVideos         Int?      @default(0) @map("total_videos")
  status              String?   @default("processing")
  quizPrepost         String?   @map("quiz_prepost")
  hasQuizPrepost      Boolean?  @default(false) @map("has_quiz_prepost")
  quizPrepostCount    Int?      @default(0) @map("quiz_prepost_count")
  courseTitle         String?   @map("course_title")
  jp                  Decimal?  @db.Decimal(8, 2)
  courseShortDesc     String?   @map("course_short_desc") @db.VarChar(500)
  courseDesc          String?   @map("course_desc")
  courseLevel         String?   @default("Beginner") @map("course_level") @db.VarChar(20)
  language            String?   @default("Bahasa Indonesia")
  requirements        String?
  outcomes            String?
  metaKeys            String?   @map("meta_keys") @db.VarChar(300)
  metaDesc            String?   @map("meta_desc") @db.VarChar(160)
  recommendedNext     String?   @map("recommended_next_courses")
  hasCourseMetadata   Boolean?  @default(false) @map("has_course_metadata")
  metadataGeneratedAt DateTime? @map("metadata_generated_at") @db.Timestamptz
  createdAt           DateTime? @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime? @default(now()) @map("updated_at") @db.Timestamptz
  processedAt         DateTime? @map("processed_at") @db.Timestamptz

  @@map("yt_playlists")
}

model YtPlaylistItem {
  id                   String    @id @default(uuid()) @db.Uuid
  playlistId           String    @map("playlist_id")
  videoId              String    @map("video_id")
  videoNo              Int       @map("video_no")
  videoTitle           String    @map("video_title")
  durationStr          String?   @map("duration_str")
  embedUrl             String?   @map("embed_url")
  audioPath            String?   @map("audio_path")
  audioFilePath        String?   @map("audio_file_path")
  transcript           String?
  hasTranscript        Boolean?  @default(false) @map("has_transcript")
  transcriptLength     Int?      @map("transcript_length")
  wordCount            Int?      @map("word_count")
  summary              String?
  hasSummary           Boolean?  @default(false) @map("has_summary")
  refinedTitle         String?   @map("refined_title")
  hasRefinedTitle      Boolean?  @default(false) @map("has_refined_title")
  quizPrepost          String?   @map("quiz_prepost")
  quizKnowledgeCheck   String?   @map("quiz_knowledge_check")
  hasQuizKnowledgeCheck Boolean?  @default(false) @map("has_quiz_knowledge_check")
  status               String?   @default("pending")
  errorMessage         String?   @map("error_message")
  createdAt            DateTime? @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime? @default(now()) @map("updated_at") @db.Timestamptz
  receivedAt           DateTime? @map("received_at") @db.Timestamptz
  processedAt          DateTime? @map("processed_at") @db.Timestamptz

  @@unique([playlistId, videoNo])
  @@map("yt_playlist_items")
}

model YtUserSettings {
  id                  String    @id @default(uuid()) @db.Uuid
  userId              String    @unique @map("user_id")
  fullName            String?   @map("full_name")
  email               String?
  role                String?   @default("user")
  emailNotifications  Boolean?  @default(true) @map("email_notifications")
  pushNotifications   Boolean?  @default(false) @map("push_notifications")
  weeklyDigest        Boolean?  @default(false) @map("weekly_digest")
  twoFactorEnabled    Boolean?  @default(false) @map("two_factor_enabled")
  newsletterSubscribed Boolean?  @default(true) @map("newsletter_subscribed")
  theme               String?   @default("light")
  language            String?   @default("en")
  autoRefreshInterval Int?      @default(10000) @map("auto_refresh_interval")
  createdAt           DateTime? @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime? @default(now()) @map("updated_at") @db.Timestamptz

  @@map("user_settings")
}

model YtCurationSession {
  id                  String    @id @default(uuid()) @db.Uuid
  sessionUuid         String    @unique @map("session_uuid")
  topic               String
  language            String?   @default("Bahasa Indonesia")
  level               String?   @default("All levels")
  targetDurationMin   Int       @default(60) @map("target_duration_min")
  includeChannels     String?   @map("include_channels")
  excludeChannels     String?   @map("exclude_channels")
  status              String    @default("searching")
  enrichmentStatus    String?   @default("pending") @map("enrichment_status") // pending, processing, completed, failed
  enrichedCourseId    String?   @map("enriched_course_id")
  totalCandidates     Int?      @default(0) @map("total_candidates")
  createdAt           DateTime? @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime? @default(now()) @map("updated_at") @db.Timestamptz
  processedAt         DateTime? @map("processed_at") @db.Timestamptz
  candidates          YtCurationCandidate[]

  @@map("yt_curation_sessions")
}

model YtCurationCandidate {
  id                String    @id @default(uuid()) @db.Uuid
  sessionId         String    @map("session_id") @db.Uuid
  videoId           String    @map("video_id")
  videoTitle        String    @map("video_title")
  videoUrl          String?   @map("video_url")
  videoThumbnail    String?   @map("video_thumbnail")
  channelTitle      String?   @map("channel_title")
  publishedAt       DateTime? @map("published_at") @db.Timestamptz
  durationSeconds   Int?      @map("duration_seconds")
  relevanceScore    Int?      @default(0) @map("relevance_score")
  levelFitScore     Int?      @default(0) @map("level_fit_score")
  pedagogyScore     Int?      @default(0) @map("pedagogy_score")
  technicalScore    Int?      @default(0) @map("technical_score")
  engagementScore   Int?      @default(0) @map("engagement_score")
  overallScore      Int?      @default(0) @map("overall_score")
  recommendation    String?   @default("maybe")
  roleSuggestion    String?   @map("role_suggestion")
  keyTopics         Json?     @map("key_topics")
  prerequisites     Json?
  aiSummary         String?   @map("ai_summary")
  aiNotes           String?   @map("ai_notes")
  selected          Boolean?  @default(false)
  orderInPlaylist   Int?      @map("order_in_playlist")
  createdAt         DateTime? @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime? @default(now()) @map("updated_at") @db.Timestamptz

  session           YtCurationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, videoId])
  @@map("yt_curation_candidates")
}

model UserBadge {
  id       String   @id
  userId   String
  badgeId  String
  earnedAt DateTime @default(now())
  Badge    Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  User     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model ProcessingJob {
  id            String    @id @default(cuid())
  type          String    // 'YOUTUBE_IMPORT', 'TRANSCRIPTION', 'CONTENT_GEN'
  status        String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  targetId      String    // CourseId or LessonId
  payload       Json?
  error         String?
  retries       Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([status])
  @@index([targetId])
}

// ============================================
// ULP RETROFIT MODELS
// ============================================

/// xAPI Outbox for reliable, idempotent event emission to LRS
model XapiOutbox {
  id             String    @id @default(uuid())
  idempotencyKey String    @unique @map("idempotency_key")
  statement      Json      // Full xAPI statement
  status         String    @default("PENDING") // PENDING, SENT, FAILED, DLQ
  attempts       Int       @default(0)
  lastError      String?   @map("last_error")
  createdAt      DateTime  @default(now()) @map("created_at")
  processedAt    DateTime? @map("processed_at")

  @@index([status, createdAt])
  @@map("xapi_outbox")
}

/// Denormalized learner activity for unified journey view
model LearnerActivity {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  courseId     String?  @map("course_id")
  activityType String   @map("activity_type") // ENROLLMENT, LESSON_COMPLETE, QUIZ_PASS, ATTENDANCE, CERTIFICATE
  entityId     String   @map("entity_id")
  entityTitle  String?  @map("entity_title")
  metadata     Json?
  occurredAt   DateTime @default(now()) @map("occurred_at")

  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, courseId, occurredAt])
  @@index([userId, occurredAt])
  @@map("learner_activity")
}

/// Sync Course Progress tracking per PRD
/// Tracks pre-learning, live session, and post-learning completion
model SyncCourseProgress {
  id                     String    @id @default(uuid())
  userId                 String    @map("user_id")
  courseId               String    @map("course_id")
  
  // Pre-Learning: Advance Organizer
  preLearnAccessedAt     DateTime? @map("pre_learn_accessed_at")
  
  // Live Session: YouTube Live
  liveAccessedAt         DateTime? @map("live_accessed_at")
  liveWatchDuration      Int       @default(0) @map("live_watch_duration") // Seconds watched
  conceptMarkers         Json?     @map("concept_markers") // Array of { timestamp, text }
  
  // Post-Learning: Concept Validation
  postLearnSubmittedAt   DateTime? @map("post_learn_submitted_at")
  assessmentScore        Float?    @map("assessment_score") // Recorded but non-blocking
  assessmentResponse     Json?     @map("assessment_response") // Snapshot of responses
  
  // Completion Status
  status                 SyncCourseStatus @default(NOT_STARTED)
  completedAt            DateTime? @map("completed_at")
  
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")
  
  User                   User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  Course                 Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, courseId])
  @@index([userId, status])
  @@index([courseId])
  @@map("sync_course_progress")
}

enum SyncCourseStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}


enum AttendanceMethod {
  QR_CODE
  MANUAL
  ZOOM_AUTO
  GPS
}

enum AttendanceStatus {
  PRESENT
  LATE
  ABSENT
  EXCUSED
}

enum BadgeType {
  ACHIEVEMENT
  MILESTONE
  STREAK
  SKILL
  SPECIAL
}

enum ContentType {
  VIDEO
  DOCUMENT
  ARTICLE
  SCORM
  EXTERNAL_LINK
  ASSIGNMENT
}

enum DeliveryMode {
  ON_CLASSROOM
  HYBRID
  ASYNC_ONLINE
  SYNC_ONLINE
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum EnrollmentStatus {
  PENDING
  ENROLLED
  COMPLETED
  DROPPED
  WAITLISTED
}

enum GradingStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum NotificationType {
  ENROLLMENT
  COURSE_UPDATE
  ASSIGNMENT_DUE
  QUIZ_RESULT
  CERTIFICATE
  BADGE_EARNED
  SESSION_REMINDER
  SYSTEM
}

enum QuestionType {
  MULTIPLE_CHOICE
  MULTIPLE_SELECT
  TRUE_FALSE
  ESSAY
  SHORT_ANSWER
  MATCHING
}

enum QuizType {
  QUIZ
  EXAM
  PRETEST
  POSTTEST
}

enum Role {
  SUPER_ADMIN
  ADMIN_UNIT
  INSTRUCTOR
  LEARNER
}

enum SessionType {
  CLASSROOM
  HYBRID
  LIVE_ONLINE
  SELF_PACED
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// ============================================
// FEEDBACK SURVEY MODELS
// ============================================

/// Feedback Survey for ON_CLASSROOM courses
model FeedbackSurvey {
  id               String             @id @default(uuid())
  courseId         String             @map("course_id")
  sessionId        String?            @map("session_id")
  title            String
  description      String?
  isActive         Boolean            @default(true)
  startsAt         DateTime?
  endsAt           DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  Course           Course             @relation(fields: [courseId], references: [id], onDelete: Cascade)
  CourseSession    CourseSession?     @relation(fields: [sessionId], references: [id])
  FeedbackResponse FeedbackResponse[]

  @@index([courseId])
  @@map("feedback_surveys")
}

/// Feedback Response from learners
model FeedbackResponse {
  id               String         @id @default(uuid())
  surveyId         String         @map("survey_id")
  userId           String         @map("user_id")

  // Rating fields (1-5 scale)
  instructorRating Int?           @map("instructor_rating")
  materialRating   Int?           @map("material_rating")
  facilityRating   Int?           @map("facility_rating")
  overallRating    Int            @map("overall_rating")

  // Text feedback
  strengths        String?        // Apa yang baik?
  improvements     String?        // Apa yang perlu diperbaiki?
  suggestions      String?        // Saran untuk penyelenggaraan berikutnya

  isAnonymous      Boolean        @default(false)
  submittedAt      DateTime       @default(now())

  Survey           FeedbackSurvey @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  User             User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([surveyId, userId])
  @@index([surveyId])
  @@map("feedback_responses")
}

// ============================================
// WORK-BASED LEARNING MODULE (WBLM)
// ============================================

enum WblmProgramStatus {
  DRAFT
  PUBLISHED
  RUNNING
  CLOSED
  ARCHIVED
}

enum WblmEnrollmentStatus {
  INVITED
  ENROLLED
  ACTIVE
  COMPLETED
  WITHDRAWN
}

enum WblmMilestoneStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  UNDER_REVIEW
  REVISION_REQUESTED
  RESUBMITTED
  APPROVED_FINAL
  LOCKED
}

enum WblmReviewDecision {
  ACCEPT
  REQUEST_REVISION
  COMMENT_ONLY
  ESCALATE
}

enum WblmReflectionStatus {
  NOT_STARTED
  SUBMITTED
  LOCKED
}

enum WblmEvidenceStatus {
  NOT_READY
  READY
  PUBLISHED
  EXPORTED
}

enum WblmReviewerRole {
  COACH
  REVIEWER
  PANELIST
}

enum WblmLearningLinkType {
  ASYNC
  SYNC
  WEBINAR
  CLASSROOM
  HYBRID
}

/// WBLM Program - A configured work-based learning run
model WblmProgram {
  id               String              @id @default(uuid())
  title            String
  description      String?
  targetRoles      String[]            @map("target_roles")
  durationWeeks    Int                 @map("duration_weeks")
  startDate        DateTime?           @map("start_date")
  endDate          DateTime?           @map("end_date")
  status           WblmProgramStatus   @default(DRAFT)
  ownerUserId      String              @map("owner_user_id")
  reviewerPoolIds  String[]            @map("reviewer_pool_ids")
  settings         Json?               // { allowSupervisorReview, reviewerScoringEnabled, maxRevisionCycles, evidenceVisibility, safeToLearnStatement }
  createdAt        DateTime            @default(now()) @map("created_at")
  updatedAt        DateTime            @updatedAt @map("updated_at")

  Owner            User                @relation("WblmProgramOwner", fields: [ownerUserId], references: [id])
  Tasks            WblmTask[]
  Milestones       WblmMilestone[]
  Enrollments      WblmEnrollment[]
  ReviewAssignments WblmReviewAssignment[]
  Reflections      WblmReflection[]
  EvidencePackages WblmEvidencePackage[]

  @@index([status])
  @@index([ownerUserId])
  @@map("wblm_programs")
}

/// WBLM Task - Assignment template per program
model WblmTask {
  id                  String        @id @default(uuid())
  programId           String        @map("program_id")
  title               String
  contextDescription  String?       @map("context_description")
  scopeLimits         String?       @map("scope_limits")
  expectedOutputs     Json?         @map("expected_outputs")   // [{ type, description }]
  successCriteria     Json?         @map("success_criteria")   // [{ name, description, weight? }]
  rubrics             Json?                                     // Rubric categories + levels
  attachments         Json?                                     // Array of file refs
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  Program             WblmProgram   @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@index([programId])
  @@map("wblm_tasks")
}

/// WBLM Milestone - Checkpoint within a program
model WblmMilestone {
  id                    String              @id @default(uuid())
  programId             String              @map("program_id")
  name                  String
  description           String?
  dueDate               DateTime?           @map("due_date")
  requiredArtifactTypes String[]            @map("required_artifact_types")
  requiresReview        Boolean             @default(true) @map("requires_review")
  requiresReflection    Boolean             @default(false) @map("requires_reflection")
  orderIndex            Int                 @default(0) @map("order_index")
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  Program               WblmProgram         @relation(fields: [programId], references: [id], onDelete: Cascade)
  LearningLinks         WblmLearningLink[]
  Submissions           WblmSubmission[]
  Reflections           WblmReflection[]
  ParticipantMilestones WblmParticipantMilestone[]

  @@index([programId])
  @@map("wblm_milestones")
}

/// WBLM Participant Milestone - Track status per participant per milestone
model WblmParticipantMilestone {
  id              String               @id @default(uuid())
  milestoneId     String               @map("milestone_id")
  participantId   String               @map("participant_id")
  status          WblmMilestoneStatus  @default(NOT_STARTED)
  updatedAt       DateTime             @updatedAt @map("updated_at")

  Milestone       WblmMilestone        @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  Participant     User                 @relation("WblmMilestoneParticipant", fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([milestoneId, participantId])
  @@map("wblm_participant_milestones")
}

/// WBLM Enrollment - Participant enrollment in a program
model WblmEnrollment {
  id                String                @id @default(uuid())
  programId         String                @map("program_id")
  participantUserId String                @map("participant_user_id")
  supervisorUserId  String?               @map("supervisor_user_id")
  status            WblmEnrollmentStatus  @default(ENROLLED)
  joinedAt          DateTime              @default(now()) @map("joined_at")
  completedAt       DateTime?             @map("completed_at")

  Program           WblmProgram           @relation(fields: [programId], references: [id], onDelete: Cascade)
  Participant       User                  @relation("WblmEnrollmentParticipant", fields: [participantUserId], references: [id], onDelete: Cascade)
  Supervisor        User?                 @relation("WblmEnrollmentSupervisor", fields: [supervisorUserId], references: [id])

  @@unique([programId, participantUserId])
  @@index([programId])
  @@index([participantUserId])
  @@map("wblm_enrollments")
}

/// WBLM Artifact Type - Configuration library for artifact types
model WblmArtifactType {
  id              String    @id @default(uuid())
  key             String    @unique
  label           String
  description     String?
  allowedFileTypes String[] @map("allowed_file_types")
  maxFileSizeMb   Int       @default(10) @map("max_file_size_mb")
  templateFileRef String?   @map("template_file_ref")
  createdAt       DateTime  @default(now()) @map("created_at")

  @@map("wblm_artifact_types")
}

/// WBLM Submission - Versioned artifact submission
model WblmSubmission {
  id                String              @id @default(uuid())
  programId         String              @map("program_id")
  milestoneId       String              @map("milestone_id")
  participantUserId String              @map("participant_user_id")
  versionNumber     Int                 @default(1) @map("version_number")
  title             String?
  notes             String?
  files             Json?               // Array of { id, storageUrl, filename, mime, size, checksum }
  status            WblmMilestoneStatus @default(SUBMITTED)
  createdAt         DateTime            @default(now()) @map("created_at")

  Milestone         WblmMilestone       @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  Participant       User                @relation("WblmSubmissionParticipant", fields: [participantUserId], references: [id], onDelete: Cascade)
  Reviews           WblmReview[]

  @@index([milestoneId, participantUserId])
  @@index([programId])
  @@map("wblm_submissions")
}

/// WBLM Review Assignment - Reviewer-participant mapping
model WblmReviewAssignment {
  id                String            @id @default(uuid())
  programId         String            @map("program_id")
  participantUserId String            @map("participant_user_id")
  reviewerUserId    String            @map("reviewer_user_id")
  milestoneId       String?           @map("milestone_id")
  role              WblmReviewerRole  @default(REVIEWER)
  assignedAt        DateTime          @default(now()) @map("assigned_at")

  Program           WblmProgram       @relation(fields: [programId], references: [id], onDelete: Cascade)
  Participant       User              @relation("WblmReviewAssignmentParticipant", fields: [participantUserId], references: [id], onDelete: Cascade)
  Reviewer          User              @relation("WblmReviewAssignmentReviewer", fields: [reviewerUserId], references: [id], onDelete: Cascade)

  @@unique([programId, participantUserId, reviewerUserId, milestoneId])
  @@index([programId])
  @@index([reviewerUserId])
  @@map("wblm_review_assignments")
}

/// WBLM Review - Review feedback and decision
model WblmReview {
  id              String              @id @default(uuid())
  submissionId    String              @map("submission_id")
  reviewerUserId  String              @map("reviewer_user_id")
  decision        WblmReviewDecision
  commentsRichtext String?            @map("comments_richtext")
  inlineComments  Json?               @map("inline_comments")  // For doc annotation integration
  score           Json?                                        // Rubric scores
  createdAt       DateTime            @default(now()) @map("created_at")

  Submission      WblmSubmission      @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  Reviewer        User                @relation("WblmReviewReviewer", fields: [reviewerUserId], references: [id], onDelete: Cascade)

  @@index([submissionId])
  @@index([reviewerUserId])
  @@map("wblm_reviews")
}

/// WBLM Reflection - Participant structured reflection
model WblmReflection {
  id                String                @id @default(uuid())
  programId         String                @map("program_id")
  participantUserId String                @map("participant_user_id")
  milestoneId       String?               @map("milestone_id")
  answers           Json?                 // { initialAssumptions, whatChanged, keyFeedback, whatWouldDoDifferently }
  status            WblmReflectionStatus  @default(NOT_STARTED)
  submittedAt       DateTime?             @map("submitted_at")
  lockedAt          DateTime?             @map("locked_at")

  Program           WblmProgram           @relation(fields: [programId], references: [id], onDelete: Cascade)
  Participant       User                  @relation("WblmReflectionParticipant", fields: [participantUserId], references: [id], onDelete: Cascade)
  Milestone         WblmMilestone?        @relation(fields: [milestoneId], references: [id])

  @@unique([programId, participantUserId, milestoneId])
  @@index([programId])
  @@map("wblm_reflections")
}

/// WBLM Evidence Package - Final evidence bundle
model WblmEvidencePackage {
  id                  String              @id @default(uuid())
  programId           String              @map("program_id")
  participantUserId   String              @map("participant_user_id")
  finalSubmissionIds  String[]            @map("final_submission_ids")
  reviewTrailIds      String[]            @map("review_trail_ids")
  reflectionId        String?             @map("reflection_id")
  finalScore          Json?               @map("final_score")
  status              WblmEvidenceStatus  @default(NOT_READY)
  publishedAt         DateTime?           @map("published_at")
  exportedAt          DateTime?           @map("exported_at")
  exportFileRef       String?             @map("export_file_ref")

  Program             WblmProgram         @relation(fields: [programId], references: [id], onDelete: Cascade)
  Participant         User                @relation("WblmEvidenceParticipant", fields: [participantUserId], references: [id], onDelete: Cascade)

  @@unique([programId, participantUserId])
  @@index([programId])
  @@map("wblm_evidence_packages")
}

/// WBLM Learning Link - Links milestones to existing learning resources
model WblmLearningLink {
  id            String                @id @default(uuid())
  programId     String                @map("program_id")
  milestoneId   String                @map("milestone_id")
  type          WblmLearningLinkType
  resourceId    String                @map("resource_id")
  title         String
  scheduleTime  DateTime?             @map("schedule_time")
  url           String?
  notes         String?
  createdAt     DateTime              @default(now()) @map("created_at")

  Milestone     WblmMilestone         @relation(fields: [milestoneId], references: [id], onDelete: Cascade)

  @@index([milestoneId])
  @@map("wblm_learning_links")
}
